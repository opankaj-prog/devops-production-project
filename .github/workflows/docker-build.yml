name: Build and Push Docker Image

on:
  push:
    branches:
      - main

jobs:
  docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/devops-prod-app:latest .

      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-prod-app:latest

  deploy:
    name: Deploy to EC2
    needs: docker        # üî• THIS WAS THE BUG
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          set -e

          IMAGE=${{ secrets.DOCKER_USERNAME }}/devops-prod-app:latest

          echo "üéØ Detecting current live color"
          CURRENT=$(~/deploy/current_color.sh)

          if [ "$CURRENT" = "green" ]; then
            NEW=blue
            NEW_PORT=5000
            OLD=green
          else
            NEW=green
            NEW_PORT=5001
            OLD=blue
          fi

          echo "‚û°Ô∏è Deploying new version to $NEW on port $NEW_PORT"

          docker pull $IMAGE

          docker stop devops-$NEW || true
          docker rm devops-$NEW || true

          docker run -d \
          --name devops-$NEW \
          -p $NEW_PORT:5000 \
          --restart always \
          $IMAGE

          echo "‚è≥ Waiting for new container"
          sleep 10

          echo "üîç Health check on new container"
          curl -f http://localhost:$NEW_PORT/health

          echo "üîÅ Switching Nginx to $NEW"
          sudo sed -i "s/127.0.0.1:[0-9]\+/127.0.0.1:$NEW_PORT/" /etc/nginx/sites-available/default
          sudo nginx -t
          sudo systemctl reload nginx

          echo "üõë Stopping old container: $OLD"
          docker stop devops-$OLD || true

          echo "‚úÖ Blue-Green deployment completed"




